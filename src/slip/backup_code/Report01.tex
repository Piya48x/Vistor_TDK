import React, { useEffect, useRef, useState } from 'react'
import { supabase } from '../supabaseClient'
import ExcelJS from 'exceljs'
import { saveAs } from 'file-saver'
import { useNavigate } from 'react-router-dom'

const USERNAME = '1234'
const PASSWORD = '1234'
const ORG = import.meta.env.VITE_ORG_NAME || 'Just-iD Visitor'
const SITE = import.meta.env.VITE_SITE_NAME || 'Global Securitech'

export default function Report() {
  // ---------------- STATE ----------------
  const [visitors, setVisitors] = useState([])
  const [selectedIds, setSelectedIds] = useState([])

  const [searchStart, setSearchStart] = useState('')
  const [searchEnd, setSearchEnd] = useState('')
  const [searchName, setSearchName] = useState('')

  // summary counters
  const [countToday, setCountToday] = useState(0)
  const [countUncheckout, setCountUncheckout] = useState(0)
  const [countRange, setCountRange] = useState(0)
  const [countCheckoutToday, setCountCheckoutToday] = useState(0)

  const printedIdsRef = useRef(new Set())
  const hasPromptedRef = useRef(false)
  const navigate = useNavigate()

  // ---------------- LOGIN ONCE ----------------
  useEffect(() => {
    if (hasPromptedRef.current) return
    hasPromptedRef.current = true
    const u = prompt('‡∏Å‡∏£‡∏≠‡∏Å Username:')
    const p = prompt('‡∏Å‡∏£‡∏≠‡∏Å Password:')
    if (!(u === USERNAME && p === PASSWORD)) {
      alert('‚ùå Username ‡∏´‡∏£‡∏∑‡∏≠ Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á')
      navigate('/')
    }
  }, [navigate])

  // ---------------- HELPERS ----------------
  const startOfDay = (d = new Date()) => {
    const x = new Date(d)
    x.setHours(0,0,0,0)
    return x
  }
  const endOfDay = (d = new Date()) => {
    const x = new Date(d)
    x.setHours(23,59,59,999)
    return x
  }

  const toISO = (d) => new Date(d).toISOString()

  // ---------------- LOADERS ----------------
  const loadVisitors = async (startDate = '', endDate = '', name = '') => {
    let q = supabase.from('visitors').select('*').order('id', { ascending: false })

    if (startDate) {
      const s = startOfDay(new Date(startDate))
      q = q.gte('checkin_time', s.toISOString())
    }
    if (endDate) {
      const e = endOfDay(new Date(endDate))
      q = q.lte('checkin_time', e.toISOString())
    }
    if (name) q = q.ilike('full_name', `%${name}%`)

    const { data, error } = await q
    if (!error) setVisitors(data || [])
  }

  const loadSummary = async (startDate = '', endDate = '') => {
    // ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    const tStart = startOfDay()
    const tEnd = endOfDay()

    // 1) ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏Å‡∏µ‡πà‡∏Ñ‡∏ô
    {
      const { count } = await supabase
        .from('visitors')
        .select('id', { count: 'exact', head: true })
        .gte('checkin_time', tStart.toISOString())
        .lte('checkin_time', tEnd.toISOString())
      setCountToday(count || 0)
    }

    // 2) ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)
    {
      const { count } = await supabase
        .from('visitors')
        .select('id', { count: 'exact', head: true })
        .is('checkout_time', null)
      setCountUncheckout(count || 0)
    }

    // 3) ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏á (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
    {
      let q = supabase.from('visitors').select('id', { count: 'exact', head: true })
      if (startDate) q = q.gte('checkin_time', startOfDay(new Date(startDate)).toISOString())
      if (endDate) q = q.lte('checkin_time', endOfDay(new Date(endDate)).toISOString())
      const { count } = await q
      setCountRange(count || 0)
    }

    // 4) ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    {
      const { count } = await supabase
        .from('visitors')
        .select('id', { count: 'exact', head: true })
        .gte('checkout_time', tStart.toISOString())
        .lte('checkout_time', tEnd.toISOString())
      setCountCheckoutToday(count || 0)
    }
  }

  // init load
  useEffect(() => {
    loadVisitors()
    loadSummary()
  }, [])

  // reload summary when filters change (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ countRange ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á)
  useEffect(() => {
    loadSummary(searchStart, searchEnd)
  }, [searchStart, searchEnd])

  // ---------------- REALTIME ----------------
  useEffect(() => {
    const channel = supabase
      .channel('visitors-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'visitors' }, (payload) => {
        // refresh list ‡∏ï‡∏≤‡∏° filter ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        loadVisitors(searchStart, searchEnd, searchName)
        // refresh summary counters
        loadSummary(searchStart, searchEnd)

        // auto print ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ insert (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
        if (payload.eventType === 'INSERT') {
          const v = payload.new
          if (v?.id && !printedIdsRef.current.has(v.id)) {
            printedIdsRef.current.add(v.id)
            window.open(`/print/${v.id}`, '_blank')
          }
        }
      })
      .subscribe()

    return () => supabase.removeChannel(channel)
  }, [searchStart, searchEnd, searchName])

  // ---------------- ACTIONS ----------------
  const checkOut = async (id) => {
    await supabase.from('visitors').update({ checkout_time: new Date().toISOString() }).eq('id', id)
    await loadVisitors(searchStart, searchEnd, searchName)
    await loadSummary(searchStart, searchEnd)
  }

  const deleteVisitor = async (ids) => {
    if (!ids.length) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô')
    if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return
    await supabase.from('visitors').delete().in('id', ids)
    setSelectedIds([])
    await loadVisitors(searchStart, searchEnd, searchName)
    await loadSummary(searchStart, searchEnd)
  }

  // ‡πÅ‡∏õ‡∏•‡πÑ‡∏ó‡∏¢ purpose
  const translatePurpose = (p, other) => {
    const map = {
      delivery: '‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á',
      meeting: '‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°',
      interview: '‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå‡∏á‡∏≤‡∏ô',
      customer: '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤',
      maintenance: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏ã‡πà‡∏≠‡∏°/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£',
      service: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏ã‡πà‡∏≠‡∏°/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£',
      visit: '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏°',
    }
    if (p === 'other') return other || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
    return map[p] || p || ''
  }

  // Export Excel (‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏ó‡∏¢ + ‡πÅ‡∏õ‡∏•‡πÑ‡∏ó‡∏¢)
  const exportToExcel = async (ids) => {
    const rows = ids.length ? visitors.filter(v => ids.includes(v.id)) : visitors
    if (!rows.length) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô')

    const wb = new ExcelJS.Workbook()
    const ws = wb.addWorksheet('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠')

    ws.columns = [
      { header: 'ID', key: 'id', width: 12 },
      { header: '‡∏ä‡∏∑‡πà‡∏≠', key: 'full_name', width: 25 },
      { header: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó', key: 'company', width: 25 },
      { header: '‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå', key: 'purpose', width: 25 },
      { header: '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠', key: 'contact_person', width: 22 },
      { header: '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤', key: 'checkin_time', width: 22 },
      { header: '‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å', key: 'checkout_time', width: 22 },
    ]
    ws.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } }
    ws.getRow(1).alignment = { vertical: 'middle', horizontal: 'center' }
    ws.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E40AF' } }
    ws.views = [{ state: 'frozen', ySplit: 1 }]
    ws.autoFilter = 'A1:G1'

    for (const v of rows) {
      ws.addRow({
        id: v.id,
        full_name: v.full_name || '',
        company: v.company || '',
        purpose: translatePurpose(v.purpose, v.other_purpose),
        contact_person: v.contact_person || '',
        checkin_time: v.checkin_time ? new Date(v.checkin_time).toLocaleString() : '',
        checkout_time: v.checkout_time ? new Date(v.checkout_time).toLocaleString() : '',
      })
    }

    const buf = await wb.xlsx.writeBuffer()
    saveAs(new Blob([buf]), `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠_${new Date().toISOString().slice(0,10)}.xlsx`)
  }

  // toggle select
  const toggleSelect = (id) =>
    setSelectedIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id])

  const toggleSelectAll = () =>
    setSelectedIds(selectedIds.length === visitors.length ? [] : visitors.map(v => v.id))

  // quick filters
  const showToday = () => {
    const t = new Date().toISOString().slice(0, 10)
    setSearchStart(t)
    setSearchEnd(t)
    setSearchName('')
    loadVisitors(t, t, '')
    loadSummary(t, t)
  }

  const showAll = () => {
    setSearchStart('')
    setSearchEnd('')
    setSearchName('')
    loadVisitors()
    loadSummary()
  }

  const showUncheckout = async () => {
    const { data, error } = await supabase
      .from('visitors')
      .select('*')
      .is('checkout_time', null)
      .order('checkin_time', { ascending: false })
    if (!error) setVisitors(data || [])
    // summary ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
  }

  // ---------------- RENDER ----------------
  return (
    <div className="container mx-auto p-6 space-y-6">
      {/* Header */}
      <div className="rounded-xl border bg-white/80 backdrop-blur p-4 shadow-sm noprint">
        <div className="grid md:grid-cols-3 items-center gap-4">
          <div className="text-blue-800 border border-blue-200 bg-blue-50 px-3 py-2 rounded-lg">
            üè¢ ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£: <b>{ORG}</b>
          </div>
          <div className="text-emerald-800 border border-emerald-200 bg-emerald-50 px-3 py-2 rounded-lg">
            üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: <b>{SITE}</b>
          </div>
        </div>
      </div>

      {/* Summary Cards */}
      <div className="noprint grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div className="rounded-2xl border shadow-sm p-4 bg-indigo-50/80">
          <div className="text-sm text-indigo-800">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</div>
          <div className="text-3xl font-semibold text-indigo-900 mt-1">{countToday}</div>
          <div className="text-xs text-indigo-700 mt-1">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà {new Date().toLocaleDateString()} 00:00</div>
        </div>
        <div className="rounded-2xl border shadow-sm p-4 bg-pink-50/80">
          <div className="text-sm text-pink-800">‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå)</div>
          <div className="text-3xl font-semibold text-pink-900 mt-1">{countUncheckout}</div>
          <div className="text-xs text-pink-700 mt-1">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</div>
        </div>
        <div className="rounded-2xl border shadow-sm p-4 bg-amber-50/80">
          <div className="text-sm text-amber-800">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á</div>
          <div className="text-3xl font-semibold text-amber-900 mt-1">{countRange}</div>
          <div className="text-xs text-amber-700 mt-1">
            {searchStart || searchEnd ? `${searchStart || '-'} ‚Üí ${searchEnd || '-'}` : '‡πÑ‡∏°‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡πà‡∏ß‡∏á'}
          </div>
        </div>
        <div className="rounded-2xl border shadow-sm p-4 bg-emerald-50/80">
          <div className="text-sm text-emerald-800">‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
          <div className="text-3xl font-semibold text-emerald-900 mt-1">{countCheckoutToday}</div>
          <div className="text-xs text-emerald-700 mt-1">‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>
        </div>
      </div>

      {/* Search & Action Bar */}
      <div className="noprint rounded-xl bg-white/80 backdrop-blur p-5 shadow-md border border-gray-200">
        <div className="flex flex-wrap items-end gap-4">
          {/* ‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà */}
          <div className="flex flex-col">
            <label className="text-sm font-medium text-gray-600 mb-1">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input
              type="date"
              value={searchStart}
              onChange={(e) => setSearchStart(e.target.value)}
              className="border border-gray-300 rounded-lg px-3 py-2 shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"
            />
          </div>

          {/* ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà */}
          <div className="flex flex-col">
            <label className="text-sm font-medium text-gray-600 mb-1">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input
              type="date"
              value={searchEnd}
              onChange={(e) => setSearchEnd(e.target.value)}
              className="border border-gray-300 rounded-lg px-3 py-2 shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"
            />
          </div>

          {/* ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ */}
          <div className="flex flex-col flex-1 min-w-[200px]">
            <label className="text-sm font-medium text-gray-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏°‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
            <input
              type="text"
              placeholder="üîé ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö..."
              value={searchName}
              onChange={(e) => setSearchName(e.target.value)}
              className="border border-gray-300 rounded-lg px-3 py-2 shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"
            />
          </div>

          {/* ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á */}
          <div className="flex flex-wrap gap-3 mt-2">
            <button
              onClick={() => loadVisitors(searchStart, searchEnd, searchName)}
              className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium shadow hover:bg-indigo-700 active:scale-[.98] transition"
            >
              üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            </button>

            <button
              onClick={showToday}
              className="bg-amber-500 text-white px-4 py-2 rounded-lg font-medium shadow hover:bg-amber-600 active:scale-[.98] transition"
            >
              üìÖ ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
            </button>

            <button
              onClick={showAll}
              className="bg-gray-500 text-white px-4 py-2 rounded-lg font-medium shadow hover:bg-gray-600 active:scale-[.98] transition"
            >
              üìÑ ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>

            <button
              onClick={showUncheckout}
              className="bg-pink-600 text-white px-4 py-2 rounded-lg font-medium shadow hover:bg-pink-700 active:scale-[.98] transition"
            >
              üö™ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå
            </button>

            <button
              onClick={() => exportToExcel(selectedIds)}
              className="bg-green-600 text-white px-4 py-2 rounded-lg font-medium shadow hover:bg-green-700 active:scale-[.98] transition"
            >
              üì§ Export Excel
            </button>

            <button
              onClick={() => deleteVisitor(selectedIds)}
              className="bg-red-600 text-white px-4 py-2 rounded-lg font-medium shadow hover:bg-red-700 active:scale-[.98] transition"
            >
              üóëÔ∏è ‡∏•‡∏ö
            </button>

            <button
              onClick={() => navigate('/')}
              className="bg-gray-800 text-white px-4 py-2 rounded-lg font-medium shadow hover:bg-gray-900 active:scale-[.98] transition"
            >
              ‚Ü©Ô∏è ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </button>
          </div>
        </div>
      </div>

      {/* Table */}
      <div className="overflow-x-auto shadow rounded border noprint">
        <table className="table-auto w-full border-collapse text-sm">
          <thead className="bg-indigo-600 text-white">
            <tr>
              <th className="border px-3 py-2 text-center">
                <input
                  type="checkbox"
                  checked={selectedIds.length === visitors.length && visitors.length > 0}
                  onChange={toggleSelectAll}
                />
              </th>
              <th className="border px-3 py-2">ID</th>
              <th className="border px-3 py-2">‡∏ä‡∏∑‡πà‡∏≠</th>
              <th className="border px-3 py-2">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
              <th className="border px-3 py-2">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</th>
              <th className="border px-3 py-2">‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</th>
              <th className="border px-3 py-2">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</th>
              <th className="border px-3 py-2">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</th>
              <th className="border px-3 py-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th className="border px-3 py-2">‡∏û‡∏¥‡∏°‡∏û‡πå</th>
              <th className="border px-3 py-2">‡∏•‡∏ö</th>
            </tr>
          </thead>
          <tbody>
            {visitors.map(v => (
              <tr
                key={v.id}
                className={`hover:bg-gray-50 ${selectedIds.includes(v.id) ? 'bg-yellow-50' : ''}`}
              >
                <td className="border px-3 py-2 text-center">
                  <input
                    type="checkbox"
                    checked={selectedIds.includes(v.id)}
                    onChange={() => toggleSelect(v.id)}
                  />
                </td>
                <td className="border px-3 py-2">{v.id}</td>
                <td className="border px-3 py-2">{v.full_name}</td>
                <td className="border px-3 py-2">{v.company}</td>
                <td className="border px-3 py-2">{v.contact_person}</td>
                <td className="border px-3 py-2">{translatePurpose(v.purpose, v.other_purpose)}</td>
                <td className="border px-3 py-2">{v.checkin_time ? new Date(v.checkin_time).toLocaleString() : ''}</td>
                <td className="border px-3 py-2">
                  {v.checkout_time ? new Date(v.checkout_time).toLocaleString() : <span className="text-gray-400">‚Äî</span>}
                </td>
                <td className="border px-3 py-2 text-center">
                  {!v.checkout_time ? (
                    <button
                      onClick={() => checkOut(v.id)}
                      className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600"
                    >
                      ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå
                    </button>
                  ) : (
                    <span className="text-green-600 font-bold">‚úî ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>
                  )}
                </td>
                <td className="border px-3 py-2 text-center">
                  <a
                    href={`/print/${v.id}`}
                    target="_blank"
                    className="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300"
                  >
                    ‡∏û‡∏¥‡∏°‡∏û‡πå
                  </a>
                </td>
                <td className="border px-3 py-2 text-center">
                  <button
                    onClick={() => deleteVisitor([v.id])}
                    className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600"
                  >
                    ‡∏•‡∏ö
                  </button>
                </td>
              </tr>
            ))}
            {visitors.length === 0 && (
              <tr>
                <td colSpan={11} className="text-center text-gray-500 py-6">
                  ‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  )
}
